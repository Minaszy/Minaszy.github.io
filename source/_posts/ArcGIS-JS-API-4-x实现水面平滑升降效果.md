---
title: ArcGIS JS API 4.x实现水面平滑升降效果
date: 2020-04-21 16:49:10
tags:
---

项目需要实现一个水闸开关时河道水面的一个升降效果，花了点时间做了一些试验，最终达到一个相对满意的效果，下面说一下思路和过程：
### 环境：arcgis js api 4.15 三维场景下
思路：
#### 首先水面数据来源主要有2种形式：
1. 三维建模的水面模型如obj/wrl/3ds等常规三维格式；
2. 矢量多边形；
项目起初是将水面数据集成在园区整体三维模型中的，也就是第1种，比较死板；另外在arcgis api demo中有效果很好的水面，是通过第2种形式实现的，可以实现水面波动效果。

#### 水面数据在arcgis js api使用的情况有如下几种：
1. 矢量多边形数据发布成要素服务设置水面效果，然后在客户端加载，调整水面高程属性；
2. 把水面模型数据制作成多面体模型，发布成场景服务，然后在客户端加载，调整水面高程属性；
模型文件的形式：
3. 将水面模型转为gltf格式，客户端创建graphic，加载水面模型；

经过测试，2/3情况下修改水面的高程属性可以实现水面升降，但是会重新渲染数据，但是升降过程卡顿，效果不佳，1情况下的升降效果较为平滑，推荐采用。

#### 最终解决方案：
即时改变图层的elevationInfo可以实现想要的效果，注意：
1. 是要给图层的elevationInfo重新赋值，直接改变elevationInfo里的offset是不行的；
2. 重新赋值的内容是自定义要素高度featureExpressionInfo，有这个参数时会代替Z值取显示模型的高度；
3. 只有featureserver的polygon面渲染成的水面才能通过上面的办法，达到平滑升降的效果；

#### 效果展示及代码分享
<img src="水面升降.gif" width=50% />